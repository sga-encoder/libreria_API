@host = http://localhost:8000/api/v1/loan
@hostAuth = http://localhost:8000/api/v1/auth
@hostBook = http://localhost:8000/api/v1/book
@hostAdmin = http://localhost:8000/api/v1/admin

# =============================================================================
# TOKENS Y CREDENCIALES
# =============================================================================

### Login como Admin para obtener token
@adminToken = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0aGVQcmltby5hZHZlbnR1cmVAdGltZS5jYXJ0b29uIiwicm9sZSI6IkFETUlOIiwiZXhwIjo3NzY5NzA3OTk4fQ.cBbl8cmINaCPoJ2Q3oLqkNJEAbNazRv4lwRuXl_vNLQ
POST {{hostAuth}}/login
Content-Type: application/json

{
  "email": "thePrimo.adventure@time.cartoon",
  "password": "adventuretime"
}


# =============================================================================
#  Login  (Users)
# =============================================================================

### Login  Starchy
@TokenStarchy = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJzdGFyY2h5LmFkdmVudHVyZUB0aW1lLmNhcnRvb24iLCJyb2xlIjoiVVNFUiIsImV4cCI6Nzc2OTcwODE5Nn0.04vgpaBjaXJWiCHsfAYPMWzX3m7xRIHcvTNhK__9i9M
@IDStarchy = 17697080639760002
POST {{hostAuth}}/login
Content-Type: application/json

{
  "email": "starchy.adventure@time.cartoon",
  "password": "adventuretime"
}



### Login Dr Donut
@TokenDrDonut = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJEckRvbnV0LmFkdmVudHVyZUB0aW1lLmNhcnRvb24iLCJyb2xlIjoiVVNFUiIsImV4cCI6Nzc2OTcwODIwOH0.1h9_dApOdRaoap8DRNRPh2_ldAD9UoaZP9bJYlXSOwc
@IDDrDonut = 17697080666840003
POST {{hostAuth}}/login
Content-Type: application/json

{
  "email": "DrDonut.adventure@time.cartoon",
  "password": "adventuretime"
}



### Login Crunchy
@TokenCrunchy = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJjcnVuY2h5LmFkdmVudHVyZUB0aW1lLmNhcnRvb24iLCJyb2xlIjoiVVNFUiIsImV4cCI6Nzc2OTcwODIyMn0.V76uYliiCwVtnePIIbrQYHA6oPZA0l_Fnpav-jXQ83I
@IDCrunchy = 17697080699570004
POST {{hostAuth}}/login
Content-Type: application/json

{
  "email": "crunchy.adventure@time.cartoon",
  "password": "adventuretime"
}

# =============================================================================
# IDs DE REFERENCIA (actualizar según BD)
# =============================================================================

# Libros (obtener desde GET /api/v1/book/)
@book_01 = 9781234567890
@book_02 = 9780553897845
@book_03 = 9780261103573
@book_04 = 9780132350884
@book_05 = 9780596007126
@book_06 = 9788497592208


### Leer todos los libros
GET {{hostBook}}/

# IDs inexistentes para pruebas negativas
@nonExistingLoanId = 99999999999999999
@nonExistingBookId = 9999999999999
@nonExistingUserId = 00000000000000000

# =============================================================================
# 1) CONFIGURAR BOOKCASE (REQUERIDO)
# =============================================================================

### Verificar estado actual del BookCase
GET {{host}}/bookcase/status
Authorization: Bearer {{adminToken}}

### Configurar BookCase con algoritmo DEFICIENT
POST {{host}}/bookcase/configure
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "algorithm_type": "DEFICIENT",
  "weight_capacity": 15.0,
  "capacity_stands": 8
}

### Configurar BookCase con algoritmo OPTIMOUM (alternativa)
# POST {{host}}/bookcase/configure
# Authorization: Bearer {{adminToken}}
# Content-Type: application/json
# 
# {
#   "algorithm_type": "OPTIMOUM",
#   "weight_capacity": 20.0,
#   "capacity_stands": 10
# }

### Ejecutar organización manual (opcional)
POST {{host}}/bookcase/organize
Authorization: Bearer {{adminToken}}

# =============================================================================
# 2) CREAR PRÉSTAMOS (usar IDs de BD actual)
# =============================================================================

### @name createLoan1
POST {{host}}/
Content-Type: application/json
Authorization: Bearer {{adminToken}}

{
  "id_user": "{{IDStarchy}}",
  "id_ISBN_book": "{{book_01}}"
}

### @name createLoan2
POST {{host}}/
Content-Type: application/json
Authorization: Bearer {{adminToken}}

{
  "id_user": "{{IDDrDonut}}",
  "id_ISBN_book": "{{book_02}}"
}

### @name createLoan3
POST {{host}}/
Content-Type: application/json
Authorization: Bearer {{adminToken}}

{
  "id_user": "{{IDCrunchy}}",
  "id_ISBN_book": "{{book_03}}"
}

### @name createLoan4
POST {{host}}/
Content-Type: application/json
Authorization: Bearer {{adminToken}}

{
  "id_user": "{{IDStarchy}}",
  "id_ISBN_book": "{{book_04}}"
}

# =============================================================================
# 3) ESTABLECER IDs DE PRÉSTAMOS CREADOS
# =============================================================================

# ⚠️ ACTUALIZAR ESTOS IDs DESPUÉS DE EJECUTAR LOS POST ANTERIORES
# Copiar los IDs de las respuestas de createLoan1-4
### Leer todos los préstamos (cualquier usuario autenticado)
GET {{host}}/
Authorization: Bearer {{TokenStarchy}}

@loanId_New01 = 17697841547260001
@loanId_New02 = 17697845157010002
@loanId_New03 = 17697845181680003
@loanId_New04 = 17697845206000004

# =============================================================================
# 4) LEER PRÉSTAMOS
# =============================================================================

### Leer préstamo específico por ID
GET {{host}}/{{loanId_New01}}
Authorization: Bearer {{TokenStarchy}}

### Leer préstamos de un usuario específico (admin)
GET {{host}}/user/{{IDStarchy}}
Authorization: Bearer {{adminToken}}

# =============================================================================
# 5) CASOS DE ERROR AL CREAR PRÉSTAMOS
# =============================================================================

### Intentar crear préstamo con libro ya prestado (debe fallar con 400)
POST {{host}}/
Content-Type: application/json
Authorization: Bearer {{adminToken}}

{
  "id_user": "{{IDDrDonut}}",
  "id_ISBN_book": "{{book_03}}"
}

### Intentar crear préstamo con usuario inexistente (debe fallar con 404)
POST {{host}}/
Content-Type: application/json
Authorization: Bearer {{adminToken}}

{
  "id_user": "{{nonExistingUserId}}",
  "id_ISBN_book": "{{book_05}}"
}

### Intentar crear préstamo con libro inexistente (debe fallar con 404)
POST {{host}}/
Content-Type: application/json
Authorization: Bearer {{adminToken}}

{
  "id_user": "{{IDCrunchy}}",
  "id_ISBN_book": "{{nonExistingBookId}}"
}

# =============================================================================
# 6) ACTUALIZAR PRÉSTAMOS (solo admin)
# =============================================================================

### Cambiar libro prestado (actualizar préstamo)
PATCH {{host}}/{{loanId_New01}}
Content-Type: application/json
Authorization: Bearer {{adminToken}}

{
  "id_ISBN_book": "{{book_06}}"
}

### Verificar que el préstamo fue actualizado
GET {{host}}/{{loanId_New01}}
Authorization: Bearer {{TokenStarchy}}

### Intentar actualizar a libro ya prestado (debe fallar con 400)
PATCH {{host}}/{{loanId_New02}}
Content-Type: application/json
Authorization: Bearer {{adminToken}}

{
  "id_ISBN_book": "{{book_06}}"
}

# =============================================================================
# 7) ELIMINAR PRÉSTAMOS (devolución)
# =============================================================================

### Devolver libro (eliminar préstamo) - solo admin
DELETE {{host}}/{{loanId_New01}}
Authorization: Bearer {{adminToken}}

### Verificar que el préstamo fue eliminado (debe retornar 404)
GET {{host}}/{{loanId_New01}}
Authorization: Bearer {{TokenStarchy}}

### Verificar que el libro ahora está disponible
GET {{hostBook}}/{{book_04}}

### Intentar eliminar préstamo inexistente (debe fallar con 404)
DELETE {{host}}/{{nonExistingLoanId}}
Authorization: Bearer {{adminToken}}

# =============================================================================
# 8) GESTIÓN DE BOOKCASE (solo admin)
# =============================================================================

### Obtener información del BookCase configurado
GET {{host}}/bookcase/status
Authorization: Bearer {{adminToken}}

### Reconfigurar BookCase con nuevo algoritmo
POST {{host}}/bookcase/configure
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "algorithm_type": "OPTIMOUM",
  "weight_capacity": 25.0,
  "capacity_stands": 12
}

### Ejecutar organización con algoritmo actual
POST {{host}}/bookcase/organize
Authorization: Bearer {{adminToken}}

### Deshabilitar BookCase
DELETE {{host}}/bookcase/disable
Authorization: Bearer {{adminToken}}

# =============================================================================
# 9) PRUEBAS DE AUTENTICACIÓN Y AUTORIZACIÓN
# =============================================================================

### Intentar crear préstamo sin token (debe fallar con 401)
POST {{host}}/
Content-Type: application/json

{
  "id_user": "{{IDStarchy}}",
  "id_ISBN_book": "{{book_05}}"
}

### Intentar actualizar préstamo con token de usuario (debe fallar con 403)
PATCH {{host}}/{{loanId_New02}}
Content-Type: application/json
Authorization: Bearer {{TokenStarchy}}

{
  "id_ISBN_book": "{{book_01}}"
}

### Intentar eliminar préstamo con token de usuario (debe fallar con 403)
DELETE {{host}}/{{loanId_New02}}
Authorization: Bearer {{TokenStarchy}}

# =============================================================================
# 10) VERIFICAR INTEGRIDAD DE DATOS
# =============================================================================

### Listar todos los préstamos activos
GET {{host}}/
Authorization: Bearer {{adminToken}}

### Verificar historial de usuario (debe incluir préstamos devueltos)
GET {{hostAuth}}/me
Authorization: Bearer {{TokenStarchy}}

### Verificar que libros devueltos están disponibles
GET {{hostBook}}/available/list

### Verificar que libros prestados no están disponibles
GET {{hostBook}}/borrowed/list

# =============================================================================
# NOTAS IMPORTANTES
# =============================================================================

# 1. ACTUALIZAR IDs:
#    - Ejecuta GET /api/v1/user/ para obtener IDs de usuarios reales
#    - Ejecuta GET /api/v1/book/ para obtener ISBNs de libros reales
#    - Actualiza las variables @user_* y @book_* con valores reales

# 2. TOKENS:
#    - Los tokens tienen expiración (ACCESS_TOKEN_EXPIRE_MINUTES)
#    - Si un endpoint falla con 401, genera nuevos tokens con POST /auth/login

# 3. BOOKCASE:
#    - DEBE configurarse antes de crear préstamos (POST /bookcase/configure)
#    - Algoritmos disponibles: "DEFICIENT", "OPTIMOUM"
#    - El algoritmo afecta cómo se organizan los libros en estantes

# 4. PERMISOS:
#    - Crear/Actualizar/Eliminar préstamos: SOLO ADMIN
#    - Leer préstamos: Cualquier usuario autenticado
#    - Configurar BookCase: SOLO ADMIN

# 5. FLUJO TÍPICO:
#    a) Admin configura BookCase
#    b) Usuario solicita préstamo (crear loan)
#    c) Admin aprueba/procesa préstamo
#    d) Usuario usa libro
#    e) Usuario devuelve libro (delete loan)
#    f) Sistema actualiza disponibilidad y historial

# 6. BASE DE DATOS:
#    - Los datos persisten en library.db (SQLite)
#    - Para reiniciar BD: elimina library.db y reinicia servidor
#    - Para migrar datos JSON: ejecuta scripts/migrate_*.py

# 7. ERRORES COMUNES:
#    - 400: Datos inválidos (libro ya prestado, campos requeridos faltantes)
#    - 401: Token inválido o expirado
#    - 403: Usuario sin permisos (requiere admin)
#    - 404: Recurso no encontrado (ID inválido)
#    - 500: Error interno (revisar logs en logs/)

# =============================================================================
# REFERENCIAS
# =============================================================================

# - Documentación API: http://localhost:8000/docs
# - Contexto completo: CONTEXTO_CHAT_MIGRACION_BD.md
# - Plan de desarrollo: PLAN_V2.md
# - Tests: test/test_loan_endpoints.py