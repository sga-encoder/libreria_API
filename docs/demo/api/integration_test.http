### =============================================================================
### TEST DE INTEGRACIÓN COMPLETO - BIBLIOTECA API
### Incluye pruebas de lista de espera y gestión avanzada de préstamos
### Ejecutar en orden para probar todo el flujo
### =============================================================================
### 
### COMANDO PARA INICIAR EL SERVIDOR:
### cd "c:\Tecnias de Prog Juan\Biblioteca\libreria_API"; uvicorn main:app --reload
### O simplemente: .\run.ps1
### =============================================================================

@host = http://localhost:8000
@adminToken = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhZG1pbkBiaWJsaW90ZWNhLnRlc3QiLCJyb2xlIjoiVVNFUiIsImV4cCI6MTc2NTQ2NzE2MH0.fjItTQTOsB5INalA12SC1YG8fd8Xt3DX7omLQmmUGNA

@user2Token = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJqdWFuLnBlcmV6QHRlc3QuY29tIiwicm9sZSI6IlVTRVIiLCJleHAiOjE3NjU0NDkwNjd9.MjeyP25h5pMUH5KKO52yP2lUV5kLmnRSzLWjdicEUgU
@user3Token = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhbmEucm9kcmlndWV6QHRlc3QuY29tIiwicm9sZSI6IlVTRVIiLCJleHAiOjE3NjU0NDkxMDJ9.uNrA22Te2fgmiI5o9kErukL2JMuVpOGj9fWupuNlKeA
@user4Token = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJjYXJsb3MuZmVybmFuZGV6QHRlc3QuY29tIiwicm9sZSI6IlVTRVIiLCJleHAiOjE3NjU0NDkxMzh9.YGQqhWr8_PmH19EhKg1vVomL9MoIPCIaAPCJPR7GUFo
@user5Token = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJsYXVyYS5zYW5jaGV6QHRlc3QuY29tIiwicm9sZSI6IlVTRVIiLCJleHAiOjE3NjU0NDkxNjl9.GRe7QOApOYFitacl45MP7K3HarjsyL2V0w2j_0uFbRI
@user6Token = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJwZWRyby5qaW1lbmV6QHRlc3QuY29tIiwicm9sZSI6IlVTRVIiLCJleHAiOjE3NjU0NDkxOTJ9.25PechH3zq5khjOphDkefmhzNx3zEVaRbpK-KUkmBBs
@popularBookISBN = 9780156012195
@loanId1 = 17654591716730002
@loanId2 = 
@loanId3 = 

### =============================================================================
### 1. HEALTH CHECK
### =============================================================================

### Test 01: Verificar que el servidor está funcionando
GET {{host}}/

### =============================================================================
### 2. ADMIN FLOW - Crear y autenticar administrador
### =============================================================================

### Test 02: Crear el primer administrador (sin autenticación)
POST {{host}}/api/v1/admin/
Content-Type: application/json

{
  "fullName": "Admin Principal",
  "email": "admin@biblioteca.test",
  "password": "admin123"
}

### Test 03: Login como administrador
# @name adminLogin
POST {{host}}/api/v1/auth/login
Content-Type: application/json

{
  "email": "admin@biblioteca.test",
  "password": "admin123"
}

### Guardar token de admin manualmente:
### Copiar el access_token de la respuesta y pegarlo arriba en @adminToken

### Test 04: Verificar sesión de administrador
GET {{host}}/api/v1/auth/me
Authorization: Bearer {{adminToken}}

### Test 05: Listar todos los administradores
GET {{host}}/api/v1/admin/
Authorization: Bearer {{adminToken}}

### =============================================================================
### 3. BOOKCASE CONFIGURATION
### =============================================================================

### Test 06: Configurar BookCase con algoritmo OPTIMOUM
POST {{host}}/api/v1/loan/bookcase/configure
Content-Type: application/json

{
  "algorithm_type": "OPTIMOUM",
  "weight_capacity": 20.0,
  "capacity_stands": 10
}

### Test 07: Obtener estado del BookCase
GET {{host}}/api/v1/loan/bookcase/status

### =============================================================================
### 4. LOGIN DE USUARIOS - Los usuarios ya están en users.json
### =============================================================================
### NOTA: Los usuarios ya están creados en data/json/users.json
### Todos tienen la contraseña: user123

### Test 08: Listar todos los usuarios existentes
GET {{host}}/api/v1/user/


@user1Token = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJtYXJpYS5nYXJjaWFAdGVzdC5jb20iLCJyb2xlIjoiVVNFUiIsImV4cCI6MTc2NTQ2MjY5OH0.2P0b-ENNk1VlXGyFFeil0VADegPWRofv5pUD33-uJCU
### Test 09: Login Usuario 1 - María García
# @name user1Login
POST {{host}}/api/v1/auth/login
Content-Type: application/json

{
  "email": "maria.garcia@test.com",
  "password": "user123"
}

### Test 10: Login Usuario 2 - Juan Pérez
# @name user2Login
POST {{host}}/api/v1/auth/login
Content-Type: application/json

{
  "email": "juan.perez@test.com",
  "password": "user123"
}

### Test 11: Login Usuario 3 - Ana Rodríguez
# @name user3Login
POST {{host}}/api/v1/auth/login
Content-Type: application/json

{
  "email": "ana.rodriguez@test.com",
  "password": "user123"
}

### Test 12: Login Usuario 4 - Carlos Fernández
# @name user4Login
POST {{host}}/api/v1/auth/login
Content-Type: application/json

{
  "email": "carlos.fernandez@test.com",
  "password": "user123"
}

### Test 13: Login Usuario 5 - Laura Sánchez
# @name user5Login
POST {{host}}/api/v1/auth/login
Content-Type: application/json

{
  "email": "laura.sanchez@test.com",
  "password": "user123"
}

### Test 14: Login Usuario 6 - Pedro Jiménez
# @name user6Login
POST {{host}}/api/v1/auth/login
Content-Type: application/json

{
  "email": "pedro.jimenez@test.com",
  "password": "user123"
}

### =============================================================================
### 5. VERIFICAR LIBROS EXISTENTES - Los libros ya están en books.json
### =============================================================================
### NOTA: Los libros ya están creados en data/json/books.json (20 libros)

### Test 15: Listar todos los libros existentes (20 libros)
GET {{host}}/api/v1/book/

### Test 16: Buscar libro por título "Principito"
GET {{host}}/api/v1/book/search/Principito

### Test 17: Verificar libro específico - El Principito
GET {{host}}/api/v1/book/9780156012195

### Test 18: Verificar libro - 1984
GET {{host}}/api/v1/book/9780451524935

### Test 19: Verificar libro - Cien años de soledad
GET {{host}}/api/v1/book/9788491050407

### =============================================================================
### 6. PRUEBAS DE LISTA DE ESPERA - Libro con alta demanda
### =============================================================================

### Test 20: Usuario 1 solicita préstamo de El Principito (ÉXITO - libro disponible)
POST {{host}}/api/v1/loan/
Content-Type: application/json

{
  "user": "maria.garcia@test.com",
  "book": "9780156012195",
  "loanDate": "2025-12-11T10:00:00"
}

### Guardar loan ID en @loanId1

### Test 21: Verificar que el libro está prestado
GET {{host}}/api/v1/book/9780307474278

### Test 22: Usuario 2 intenta solicitar el mismo libro (debería entrar a lista de espera)
POST {{host}}/api/v1/loan/
Content-Type: application/json

{
  "user": "juan.perez@test.com",
  "book": "9780156012195",
  "loanDate": "2025-12-11T11:00:00"
}

### Test 23: Usuario 3 también solicita el libro (segunda posición en lista de espera)
POST {{host}}/api/v1/loan/
Content-Type: application/json

{
  "user": "ana.rodriguez@test.com",
  "book": "9780156012195",
  "loanDate": "2025-12-11T12:00:00"
}

### Test 24: Usuario 4 solicita el libro (tercera posición en lista de espera)
POST {{host}}/api/v1/loan/
Content-Type: application/json

{
  "user": "carlos.fernandez@test.com",
  "book": "9780156012195",
  "loanDate": "2025-12-11T13:00:00"
}

### Test 25: Usuario 5 solicita el libro (cuarta posición en lista de espera)
POST {{host}}/api/v1/loan/
Content-Type: application/json

{
  "user": "laura.sanchez@test.com",
  "book": "9780156012195",
  "loanDate": "2025-12-11T14:00:00"
}

### Test 26: Listar todos los préstamos activos
GET {{host}}/api/v1/loan/

### Test 27: Verificar la cola de reservas (reservation queue)
### Debería mostrar 4 usuarios en espera por El Principito
GET {{host}}/api/v1/loan/reservations/queue

### Test 28: Usuario 1 devuelve el libro (debería asignarse automáticamente a Usuario 2)
DELETE {{host}}/api/v1/loan/{{loanId1}}

### Test 29: Verificar que la cola de reservas se redujo (ahora solo 3 usuarios)
### Usuario 2 ya no debe estar en la cola porque recibió el libro automáticamente
GET {{host}}/api/v1/loan/reservations/queue

### Test 30: Verificar todos los préstamos activos (Usuario 2 debe tener El Principito)
GET {{host}}/api/v1/loan/

### Test 31: Verificar que el libro "El Principito" ahora está prestado a Usuario 2
GET {{host}}/api/v1/book/9780156012195

### =============================================================================
### 7. PRÉSTAMOS MÚTIPLES SIMULTÁNEOS
### =============================================================================

### Test 32: Usuario 3 solicita libro "1984"
POST {{host}}/api/v1/loan/
Content-Type: application/json

{
  "user": "ana.rodriguez@test.com",
  "book": "9780451524935",
  "loanDate": "2025-12-11T15:00:00"
}

### Test 33: Usuario 4 solicita "Cien años de soledad"
POST {{host}}/api/v1/loan/
Content-Type: application/json

{
  "user": "carlos.fernandez@test.com",
  "book": "9788491050407",
  "loanDate": "2025-12-11T15:30:00"
}

### Test 34: Usuario 5 intenta solicitar "1984" (ya prestado, debe entrar a lista de espera)
POST {{host}}/api/v1/loan/
Content-Type: application/json

{
  "user": "laura.sanchez@test.com",
  "book": "9780451524935",
  "loanDate": "2025-12-11T16:00:00"
}

### Test 35: Listar todos los préstamos activos y en espera
GET {{host}}/api/v1/loan/

### =============================================================================
### 8. GESTIÓN AVANZADA DE PRÉSTAMOS
### =============================================================================

### Test 36: Buscar préstamo por libro específico
GET {{host}}/api/v1/loan/?book=9780156012195

### Test 37: Buscar préstamos por usuario específico
GET {{host}}/api/v1/loan/?user=maria.garcia@test.com

### Test 38: Obtener préstamo específico por ID
GET {{host}}/api/v1/loan/{{loanId1}}

### Test 39: Intentar devolver un libro que no existe (debe fallar)
DELETE {{host}}/api/v1/loan/99999999999999999

### =============================================================================
### 9. OPERACIONES DE BOOKCASE CON MÚLTIPLES LIBROS
### =============================================================================

### Test 40: Usuario 3 devuelve "1984" (debe asignarse a Usuario 5 en espera)
DELETE {{host}}/api/v1/loan/{{loanId2}}

### Test 41: Verificar estado del BookCase después de devoluciones
GET {{host}}/api/v1/loan/bookcase/status

### Test 42: Organizar bookcase manualmente
POST {{host}}/api/v1/loan/bookcase/organize
Authorization: Bearer {{adminToken}}

### Test 43: Verificar organización del bookcase
GET {{host}}/api/v1/loan/bookcase/status

### =============================================================================
### 10. PRUEBAS DE PERMISOS Y VALIDACIONES
### =============================================================================

### Test 44: Usuario normal intenta crear un libro (debe fallar)
POST {{host}}/api/v1/book/
Authorization: Bearer {{user1Token}}
Content-Type: application/json

{
  "title": "Libro Prohibido",
  "author": "Usuario Normal",
  "id_IBSN": "9999999999999",
  "gender": "Test",
  "yearPublished": 2025,
  "weight": 0.5,
  "price": 10.0
}

### Test 45: Usuario normal intenta crear bookcase (debe fallar)
POST {{host}}/api/v1/admin/bookcase
Authorization: Bearer {{user1Token}}
Content-Type: application/json

{
  "typeOrdering": "OPTIMOUM",
  "weighCapacity": 15.0,
  "capacityStands": 5
}

### Test 46: Intentar crear préstamo con usuario inexistente (debe fallar)
POST {{host}}/api/v1/loan/
Content-Type: application/json

{
  "user": "noexiste@test.com",
  "book": "9780156012195",
  "loanDate": "2025-12-11T20:00:00"
}

### Test 47: Intentar crear préstamo con libro inexistente (debe fallar)
POST {{host}}/api/v1/loan/
Content-Type: application/json

{
  "user": "maria.garcia@test.com",
  "book": "9999999999999",
  "loanDate": "2025-12-11T20:00:00"
}

### =============================================================================
### 11. ACTUALIZACIÓN DE DATOS
### =============================================================================

### Test 48: Actualizar información de usuario
PATCH {{host}}/api/v1/user/17654425996320001
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "fullName": "María García López - Actualizada"
}

### Test 49: Actualizar información de libro
PATCH {{host}}/api/v1/book/9780156012195
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "price": 16.99,
  "description": "Edición actualizada con ilustraciones"
}

### Test 50: Verificar actualización del libro
GET {{host}}/api/v1/book/9780156012195

### =============================================================================
### 12. BÚSQUEDAS Y FILTROS
### =============================================================================

### Test 51: Buscar todos los libros de ficción
GET {{host}}/api/v1/book/search/Ficción

### Test 52: Buscar libros por autor
GET {{host}}/api/v1/book/search/Orwell

### Test 53: Obtener información completa de un usuario
GET {{host}}/api/v1/user/

### =============================================================================
### 13. DEVOLUCIONES Y LIMPIEZA DE LISTA DE ESPERA
### =============================================================================

### Test 54: Usuario 2 devuelve El Principito (debe asignarse a Usuario 3)
DELETE {{host}}/api/v1/loan/{{loanId2}}

### Test 55: Verificar nueva asignación
GET {{host}}/api/v1/loan/

### Test 56: Usuario 4 devuelve su libro
DELETE {{host}}/api/v1/loan/{{loanId3}}

### Test 57: Estado final de todos los préstamos
GET {{host}}/api/v1/loan/

### =============================================================================
### 14. RECONFIGURACIÓN DE BOOKCASE
### =============================================================================

### Test 58: Cambiar configuración a DEFICIENT
POST {{host}}/api/v1/loan/bookcase/configure
Content-Type: application/json

{
  "algorithm_type": "DEFICIENT",
  "weight_capacity": 15.0,
  "capacity_stands": 8
}

### Test 59: Verificar nueva configuración
GET {{host}}/api/v1/loan/bookcase/status

### Test 60: Organizar con nuevo algoritmo
POST {{host}}/api/v1/loan/bookcase/organize
Authorization: Bearer {{adminToken}}

### =============================================================================
### 15. RESUMEN FINAL Y ESTADÍSTICAS
### =============================================================================

### Test 61: Estado final - Todos los usuarios
GET {{host}}/api/v1/user/

### Test 62: Estado final - Todos los libros
GET {{host}}/api/v1/book/

### Test 63: Estado final - Todos los préstamos
GET {{host}}/api/v1/loan/

### Test 64: Estado final - BookCase
GET {{host}}/api/v1/loan/bookcase/status

### Test 65: Estado final - Admins
GET {{host}}/api/v1/admin/
Authorization: Bearer {{adminToken}}

### Test 66: Verificar sesión del admin sigue activa
GET {{host}}/api/v1/auth/me
Authorization: Bearer {{adminToken}}

### Test 67: Verificar sesión de usuario 1
GET {{host}}/api/v1/auth/me
Authorization: Bearer {{user1Token}}

### =============================================================================
### NOTAS IMPORTANTES PARA LISTA DE ESPERA
### =============================================================================

# FLUJO DE PRUEBA DE LISTA DE ESPERA:
# 1. Usuario 1 solicita El Principito → ✓ Préstamo activo
# 2. Usuario 2 solicita El Principito → ⏳ Lista de espera posición 1
# 3. Usuario 3 solicita El Principito → ⏳ Lista de espera posición 2
# 4. Usuario 4 solicita El Principito → ⏳ Lista de espera posición 3
# 5. Usuario 5 solicita El Principito → ⏳ Lista de espera posición 4
# 6. Usuario 1 devuelve → Usuario 2 recibe automáticamente el libro
# 7. Usuario 2 devuelve → Usuario 3 recibe automáticamente el libro
# 8. Y así sucesivamente...

# DATOS IMPORTANTES:
# - Usuarios ya están en users.json (6 usuarios, password: user123)
# - Libros ya están en books.json (20 libros)
# - Solo necesitas crear el admin y hacer login con los usuarios

# TOKENS A COPIAR MANUALMENTE:
# - @adminToken: Del Test 03 (Login admin)
# - @user1Token: Del Test 09 (Login María)
# - @user2Token: Del Test 10 (Login Juan)
# - @user3Token: Del Test 11 (Login Ana)
# - @user4Token: Del Test 12 (Login Carlos)
# - @user5Token: Del Test 13 (Login Laura)
# - @user6Token: Del Test 14 (Login Pedro)
# - @loanId1: Del Test 20 (Primer préstamo)
# - @loanId2: Del Test 31 o actualización automática
# - @loanId3: Del Test 32

# RESULTADOS ESPERADOS:
# - Tests 43-46: Deben fallar (validaciones y permisos)
# - Test 22-25: Pueden devolver información de lista de espera
# - Tests de devolución: Deben reasignar automáticamente a siguiente usuario
# - Todos los demás: Deben pasar (200/201)

### =============================================================================
### 16. TESTS DETALLADOS DEL ALGORITMO DEFICIENT
### =============================================================================
### Estos tests verifican el funcionamiento completo del algoritmo DEFICIENT
### incluyendo la organización de estantes y detección de combinaciones peligrosas

### Test 68: Configurar BookCase con algoritmo DEFICIENT y baja capacidad (1kg)
POST {{host}}/api/v1/loan/bookcase/configure
Content-Type: application/json

{
  "algorithm_type": "DEFICIENT",
  "weight_capacity": 1.0,
  "capacity_stands": 20
}

### Test 69: Ejecutar organización con DEFICIENT (requiere admin)
# Este test organizará los libros en estantes y detectará combinaciones peligrosas
# Respuesta esperada: estantes creados con múltiples libros y lista de combinaciones peligrosas
POST {{host}}/api/v1/loan/bookcase/organize
Authorization: Bearer {{adminToken}}

### Test 70: Verificar estantes creados por DEFICIENT
# Debe mostrar:
# - Lista de estantes (shelves) con sus libros
# - Combinaciones peligrosas detectadas
# - Estadísticas de organización
GET {{host}}/api/v1/loan/bookcase/status

### Test 71: Reconfigurar con capacidad de 5kg para diferentes combinaciones
POST {{host}}/api/v1/loan/bookcase/configure
Content-Type: application/json

{
  "algorithm_type": "DEFICIENT",
  "weight_capacity": 5.0,
  "capacity_stands": 15
}

### Test 72: Reorganizar con nueva capacidad
POST {{host}}/api/v1/loan/bookcase/organize
Authorization: Bearer {{adminToken}}

### Test 73: Verificar nueva organización (menos estantes, más libros por estante)
GET {{host}}/api/v1/loan/bookcase/status

### Test 74: Cambiar a algoritmo OPTIMOUM para comparación
POST {{host}}/api/v1/loan/bookcase/configure
Content-Type: application/json

{
  "algorithm_type": "OPTIMOUM",
  "weight_capacity": 8.0,
  "capacity_stands": 10
}

### Test 75: Ejecutar OPTIMOUM
POST {{host}}/api/v1/loan/bookcase/organize
Authorization: Bearer {{adminToken}}

### Test 76: Comparar resultado OPTIMOUM vs DEFICIENT
GET {{host}}/api/v1/loan/bookcase/status

### =============================================================================
### FIN DEL TEST DE INTEGRACIÓN COMPLETO
### =============================================================================

### =============================================================================
### 17. TESTS DEL ALGORITMO TOTALVALUE - Cálculo de valor total por autor
### =============================================================================
### Estos tests verifican el funcionamiento del algoritmo TotalValue que usa
### recursión y Stack para calcular el valor total de libros de un autor

### Test 77: Calcular valor total de libros de J.R.R. Tolkien (tiene 2 libros)
# Respuesta esperada: suma del precio de "El Señor de los Anillos" y "El Hobbit"
GET {{host}}/api/v1/book/author/J.R.R. Tolkien/total-value

### Test 78: Calcular valor total de libros de George Orwell (tiene 1 libro)
# Respuesta esperada: precio de "1984" (18.50)
GET {{host}}/api/v1/book/author/George Orwell/total-value

### Test 79: Calcular valor total de libros de Gabriel García Márquez (tiene 1 libro)
# Respuesta esperada: precio de "Cien años de soledad"
GET {{host}}/api/v1/book/author/Gabriel García Márquez/total-value

### Test 80: Calcular valor total de libros de un autor con muchos libros
# En este caso probamos con autores que tienen múltiples libros
GET {{host}}/api/v1/book/author/Miguel de Cervantes/total-value

### Test 81: Calcular valor total de un autor inexistente
# Respuesta esperada: total_value: 0.0, books_count: 0
GET {{host}}/api/v1/book/author/Autor Inexistente/total-value

### Test 82: Calcular valor total con nombre de autor con caracteres especiales
GET {{host}}/api/v1/book/author/Antoine de Saint-Exupéry/total-value

### Test 83: Verificar que el cálculo incluye información detallada
# Debe retornar: author, total_value, books_count y lista de books
GET {{host}}/api/v1/book/author/Dan Brown/total-value

### Test 84: Calcular valor después de agregar un nuevo libro del mismo autor
# Primero verificamos el valor actual
GET {{host}}/api/v1/book/author/Jane Austen/total-value

### Test 85: Crear un nuevo libro de Jane Austen (requiere admin)
POST {{host}}/api/v1/book/
Authorization: Bearer {{adminToken}}
Content-Type: application/json

{
  "title": "Emma",
  "author": "Jane Austen",
  "id_IBSN": "9780141439587",
  "gender": "Romance",
  "yearPublished": 1815,
  "weight": 0.45,
  "price": 19.99,
  "description": "Una novela sobre las complicaciones del cortejo y la clase social"
}

### Test 86: Recalcular valor total de Jane Austen (ahora debe incluir el nuevo libro)
# Respuesta esperada: suma del libro anterior + 19.99
GET {{host}}/api/v1/book/author/Jane Austen/total-value

### Test 87: Comparar valores totales de diferentes autores
# Test para verificar que los cálculos son independientes por autor
GET {{host}}/api/v1/book/author/Carlos Ruiz Zafón/total-value

### Test 88: Verificar autor con nombre compuesto
GET {{host}}/api/v1/book/author/Ken Follett/total-value

### Test 89: Verificar que el algoritmo funciona con inventario completo
# Listar todos los libros para confirmar el estado del inventario
GET {{host}}/api/v1/book/

### Test 90: Calcular valor total para verificar recursión con Stack
# Este test confirma que el algoritmo TotalValue procesa correctamente usando Stack
GET {{host}}/api/v1/book/author/Ildefonso Falcones/total-value

### =============================================================================
### NOTAS SOBRE EL ALGORITMO TOTALVALUE
### =============================================================================

# FUNCIONAMIENTO DEL ALGORITMO:
# 1. Recibe una lista de todos los libros del inventario
# 2. Crea una pila (Stack) y añade todos los libros
# 3. Procesa recursivamente cada libro sacándolo de la pila
# 4. Si el autor del libro coincide, suma su precio al acumulado
# 5. Retorna el valor total cuando la pila está vacía

# ESTRUCTURA DE RESPUESTA:
# {
#   "message": "Valor total calculado para el autor 'X'",
#   "data": {
#     "author": "Nombre del Autor",
#     "total_value": 99.99,
#     "books_count": 3,
#     "books": [
#       {
#         "title": "Título del Libro",
#         "isbn": "9780123456789",
#         "price": 19.99
#       },
#       ...
#     ]
#   }
# }

# CASOS DE PRUEBA:
# - Autor con 0 libros: total_value = 0.0
# - Autor con 1 libro: total_value = precio del libro
# - Autor con múltiples libros: total_value = suma de todos los precios
# - Nombres con caracteres especiales: debe funcionar correctamente
# - Sensible a mayúsculas/minúsculas: debe coincidir exactamente

### =============================================================================
### FIN DE TESTS DE TOTALVALUE
### =============================================================================

### =============================================================================
### TESTS DE GLOBALREPORT - REPORTE GLOBAL DE INVENTARIO
### =============================================================================
### 
### DESCRIPCIÓN:
### El endpoint globalReport genera un reporte ordenado de todos los libros
### del inventario según su valor. Permite ordenar ascendente/descendente
### y opcionalmente guardar el reporte en formato CSV o JSON.
### =============================================================================

### Test 91: Generar reporte global básico (JSON, descendente)
# Obtiene todos los libros ordenados de mayor a menor valor
# No guarda archivo, solo retorna el reporte
GET {{host}}/api/v1/book/report/global

### Test 92: Generar reporte global ascendente (de menor a mayor valor)
# Útil para identificar los libros de menor valor
GET {{host}}/api/v1/book/report/global?descending=false

### Test 93: Generar reporte y guardar en formato JSON
# Crea un archivo JSON en docs/demo/result_demos con timestamp
GET {{host}}/api/v1/book/report/global?save_file=true&format=json

### Test 94: Generar reporte y guardar en formato CSV
# Crea un archivo CSV con una fila final mostrando el TOTAL
GET {{host}}/api/v1/book/report/global?save_file=true&format=csv

### Test 95: Generar reporte CSV ascendente con archivo
# Combina ordenamiento ascendente con guardado en CSV
GET {{host}}/api/v1/book/report/global?save_file=true&format=csv&descending=false

### Test 96: Verificar inventario antes de generar reporte
# Listar todos los libros para confirmar el estado del inventario
GET {{host}}/api/v1/book/

### Test 97: Generar reporte con campo de valor personalizado
# Aunque value_cop es el campo por defecto, se puede especificar explícitamente
GET {{host}}/api/v1/book/report/global?value_key=value_cop

### =============================================================================
### NOTAS SOBRE EL ALGORITMO GLOBALREPORT
### =============================================================================

# FUNCIONAMIENTO DEL ALGORITMO:
# 1. Obtiene todos los libros del inventario
# 2. Convierte cada libro a diccionario
# 3. Ordena los libros por el campo especificado (value_key)
# 4. Opcionalmente guarda el reporte en CSV (con fila TOTAL) o JSON
# 5. Retorna el reporte ordenado con estadísticas

# ESTRUCTURA DE RESPUESTA:
# {
#   "message": "Reporte global generado exitosamente",
#   "data": {
#     "books": [
#       {
#         "id_IBSN": "9780123456789",
#         "title": "Título del Libro",
#         "author": "Nombre Autor",
#         "value_cop": 25000,
#         "weight": 0.5,
#         ...
#       },
#       ...
#     ],
#     "total_books": 50,
#     "total_value": 1250000.00,
#     "format": "json",
#     "file_saved": "docs/demo/result_demos/global_report_20251211_123045.json"  // solo si save_file=true
#   }
# }

# PARÁMETROS DE CONSULTA:
# - format: 'csv' o 'json' (default: 'json')
# - value_key: campo por el cual ordenar (default: 'value_cop')
# - descending: true para mayor->menor, false para menor->mayor (default: true)
# - save_file: true para guardar archivo, false solo retornar (default: false)

# CASOS DE USO:
# - Auditoría de inventario: ver todos los libros con su valor
# - Identificar libros más valiosos: usar descending=true
# - Identificar libros menos valiosos: usar descending=false
# - Exportar reporte: usar save_file=true con formato deseado
# - Análisis en Excel: exportar en CSV para abrir en Excel

# FORMATO CSV:
# - Incluye encabezados con todos los campos de los libros
# - Última fila contiene "TOTAL" y la suma de todos los valores
# - Útil para análisis rápido del valor total del inventario

# FORMATO JSON:
# - Lista de objetos JSON con todos los campos
# - Fácil de procesar programáticamente
# - Mantiene tipos de datos originales

### =============================================================================
### FIN DE TESTS DE GLOBALREPORT
### =============================================================================

### =============================================================================
### TESTS DE AVERAGEWEIGHTTAIL - PESO PROMEDIO CON RECURSIÓN DE COLA
### =============================================================================
### 
### DESCRIPCIÓN:
### El endpoint average-weight calcula el peso promedio de todos los libros
### de un autor específico utilizando un algoritmo de recursión de cola
### (tail recursion). El algoritmo muestra en consola cada paso de la recursión
### para demostrar el funcionamiento de los acumuladores.
### =============================================================================

### Test 98: Calcular peso promedio de autor con múltiples libros
# J.R.R. Tolkien tiene 2 libros con pesos diferentes
# Revisar la consola del servidor para ver la recursión de cola en acción
GET {{host}}/api/v1/book/author/J.R.R. Tolkien/average-weight

### Test 99: Calcular peso promedio de autor con un solo libro
# Gabriel García Márquez tiene 1 libro
GET {{host}}/api/v1/book/author/Gabriel García Márquez/average-weight

### Test 100: Calcular peso promedio de autor inexistente
# Debe retornar average_weight: 0.0 y total_books: 0
GET {{host}}/api/v1/book/author/Autor Inexistente/average-weight

### Test 101: Calcular peso promedio para múltiples autores
# Ken Follett tiene varios libros
GET {{host}}/api/v1/book/author/Ken Follett/average-weight

### Test 102: Verificar autor con caracteres especiales en el nombre
# Miguel de Cervantes
GET {{host}}/api/v1/book/author/Miguel de Cervantes/average-weight

### Test 103: Calcular peso promedio - Ildefonso Falcones
GET {{host}}/api/v1/book/author/Ildefonso Falcones/average-weight

### Test 104: Listar todos los libros para verificar inventario
# Útil para ver qué autores tienen libros disponibles
GET {{host}}/api/v1/book/

### =============================================================================
### NOTAS SOBRE EL ALGORITMO AVERAGEWEIGHTTAIL
### =============================================================================

# FUNCIONAMIENTO DEL ALGORITMO:
# 1. Utiliza recursión de cola (tail recursion) con acumuladores
# 2. Procesa cada libro del inventario de forma recursiva
# 3. Mantiene acumuladores para:
#    - total_weight: suma de pesos de libros del autor
#    - count: número de libros del autor encontrados
#    - index: posición actual en la lista
# 4. Muestra en consola cada paso de la recursión (logging educativo)
# 5. Al llegar al caso base, calcula el promedio: total_weight / count

# VENTAJAS DE LA RECURSIÓN DE COLA:
# - Optimizable por el compilador/intérprete
# - No crece la pila de llamadas (tail call optimization)
# - Usa acumuladores en lugar de esperar resultados de llamadas recursivas
# - Más eficiente que recursión tradicional

# LOGGING EN CONSOLA:
# El algoritmo imprime en la consola del servidor:
# - Nivel de profundidad de cada llamada recursiva
# - Libro actual siendo procesado
# - Estado de los acumuladores (total_weight, count)
# - Si el libro coincide con el autor buscado
# - Caso base y cálculo final del promedio

# ESTRUCTURA DE RESPUESTA:
# {
#   "message": "Peso promedio calculado para el autor 'X' usando recursión de cola",
#   "data": {
#     "author": "Nombre del Autor",
#     "average_weight": 0.825,
#     "total_books": 2,
#     "books": [
#       {
#         "title": "Título del Libro",
#         "isbn": "9780123456789",
#         "weight": 1.2
#       },
#       ...
#     ]
#   }
# }

# CASOS DE PRUEBA:
# - Autor con 0 libros: average_weight = 0.0
# - Autor con 1 libro: average_weight = peso del libro
# - Autor con múltiples libros: average_weight = suma_pesos / cantidad
# - Revisar consola para ver proceso recursivo completo

# EJEMPLO DE OUTPUT EN CONSOLA:
# ================================================================================
# INICIANDO CÁLCULO DE PESO PROMEDIO - RECURSIÓN DE COLA
# Autor buscado: 'J.R.R. Tolkien'
# Total de libros en inventario: 20
# ================================================================================
# 
# [RECURSIÓN COLA - Nivel 0] Procesando libro 1/20
# ├─ Título: 'El tiempo entre costuras'
# ├─ Autor: 'María Dueñas'
# ├─ Peso: 0.65 kg
# ├─ ✗ NO coincide (buscando 'J.R.R. Tolkien')
# └─ → Llamada recursiva sin actualizar acumuladores
# ...
# [RECURSIÓN COLA - Nivel N] CASO BASE ALCANZADO
# ├─ Total de libros procesados: 20
# ├─ Libros del autor 'J.R.R. Tolkien': 2
# ├─ Peso total acumulado: 1.65 kg
# └─ RESULTADO: 0.8250 kg (promedio = 1.65 / 2)

### =============================================================================
### FIN DE TESTS DE AVERAGEWEIGHTTAIL
### =============================================================================


